# Audit Global et Plan d'Action – ManusBranch

## Objectif

Effectuer un audit technique et fonctionnel complet, vérifier la cohérence entre le code et la documentation, identifier le code obsolète, et produire des plans d'action précis avec checklists markdown.

## Étapes de l'Audit

- [x] 1. Analyse du code obsolète ou redondant
  - [x] 1.1. Identifier les composants, hooks, fichiers CSS, utilitaires ou handlers non utilisés (Ex: `concerts-mobile.css`, `styles/components/concerts.css` semblent non utilisés)
  - [x] 1.2. Identifier les composants, hooks, fichiers CSS, utilitaires ou handlers dupliqués (Ex: `ActionButton.js` vs `Button.js` - fonctionnalités de tooltip et gestion d'icône se chevauchent, `Spinner.js` vs `ui/LoadingSpinner.js  - [x] 1.3. Identifier les composants, hooks, fichiers CSS, utilitaires ou handlers trop longs ou difficiles à maintenir (Ex: `useGenericEntityDetails.js` est très long (plus de 500 lignes) et gère une logique complexe, à évaluer pour scission ou refactoring ; `ContratPDFWrapper.js` est également volumineux).4. Vérifier la migration vers la nouvelle architecture (ex: `useGenericEntity*`, `StatutBadge`) (Ex: `useArtisteDetails.js` est déprécié et redirige vers version migrée, `useGenericEntity*` sont bien utilisés)5. Vérifier la suppression complète des patterns obsolètes (ex: `useResponsiveComponent` - confirmé non utilisé directement)
- [x] 2. Audit de l'architecture et de la structure du code
  - [ ] 2.1. Vérifier la cohérence de l'arborescence des fichiers (En cours: la structure globale par entité métier dans `components` et `hooks` semble cohérente. Dossiers `common`, `ui`, `layout`, `molecules` pour le transversal. `debug.js` dans `components` et `firestore/`, `lists/` dans `hooks` à investiguer.)
  - [ ] 2.2. Signaler les composants ou hooks trop imbriqués (En cours: Détection de plus de 130 fichiers à 5 niveaux de profondeur ou plus, notamment dans `components/artistes/desktop/sections`, `components/concerts/desktop/sections`, `components/lieux/desktop/sections`, `components/programmateurs/desktop/sections`, `components/structures/desktop/sections`. À analyser pour simplification poten  - [ ] 2.3. Signaler les importations incohérentes (relatif vs absolu) (En cours: Forte prédominance des imports relatifs (537) sur les absolus (58). Recommander une standardisation vers les imports absolus pour améliorer la lisibilité et la maintenabilité  - [x] 2.4. Signaler les dépendances croisées ou circulaires (Madge installé avec succès, aucune dépendance circulaire détectée.)
- [x] 3. Audit de la sécurité
  - [x] 3.1. Vérifier les protections autour des liens de formulaire avec token (Système de token UUIDv4 en place pour les formulaires publics, avec validation et expiration. Robustesse à confirmer lors des tests fonctionnels.)
  - [ ] 3.2. Vérifier les règles Firestore (Fichier `firestore.rules` absent du projet. Documentation existante ne mentionne pas la gestion des règles. Risque potentiel à investiguer. Demander à l'utilisateur si géré via console Firebas  - [x] 3.3. Détecter les risques d’injection (HTML, Firestore, JavaScript) (Utilisation de `dangerouslySetInnerHTML` dans `src/components/contrats/fullscreenEditorModal.js` et présence de balises `<script>` dans `src/components/contrats/desktop/hooks/useContratTemplatePreview.js` et `src/hooks/contrats/useContratTemplatePreview.js` - risques d'injection XSS à vérifier. Aucune concaténation suspecte trouvée dans les requêtes Firestore pour l'instant.  - [x] 3.4. Vérifier l’absence d’exposition de données sensibles dans le frontend (Aucune exposition directe de secrets ou clés API critiques dans le code source client en dehors de la configuration Firebase normale et des mécanismes d'authentification. `firebaseConfig` est visible, ce qui est attendu. Présence de `API_KEY` dans `useLocationIQ.js` à vérifier si c'est une clé publique ou si elle devrait être gérée côté backend- [x] 4. Audit de la performance- [x] 4.1. Identifier les composants avec des chargements trop lourds (`useGenericEntityDetails.js` (20KB), `ContratPDFWrapper.js` (16KB), `StructuresList.js` (15KB), `LegalInfoSection.js` (15KB), `useConcertDetailsMigrated.js` (14KB) identifiés comme les plus volumineux. Analyse pour optimisation ou scission recommandée.)
  - [x] 4.2. Détecter les requêtes redondantes ou non optimisées à Firebase (55 occurrences de `getDocs` ou `onSnapshot` identifiées. Une analyse manuelle approfondie est nécessaire pour chaque cas afin de détecter les redondances, les optimisations possibles (indexation, requêtes plus ciblées) et s'assurer que les listeners `onSnapshot` sont correctement détachés pour éviter les fuites mémoire.)
  - [x] 4.3. Vérifier l’usage correct du lazy loading (`React.lazy`, `Suspense`) (Utilisation confirmée dans `App.js`, `hooks/common/useResponsive.js`, `pages/ContratsPage.js`. Vérifier si d'autres routes/composants pourraient en bénéficier.)
  - [x] 4.4. Signaler les usages abusifs ou incorrects de `useEffect` (102 occurrences de `useEffect` trouvées. Aucune instance sans tableau de dépendances explicite n'a été détectée par la recherche automatisée. Une revue manuelle plus approfondie serait nécessaire pour identifier des dépendances incorrectes ou des effets de bord non gérés.)
- [x] 5. Audit des bugs et de la stratégie de test
  - [x] 5.1. Identifier les zones critiques du projet où des bugs peuvent se produire (Basé sur l'audit précédent, les zones critiques incluent la génération de PDF (`ContratPDFWrapper.js`, `ContratGenerator.js`), les formulaires complexes (création/édition d'entités), l'authentification (`AuthContext.js`, `LoginPage.js`), les interactions Firestore (hooks `useGenericEntity*`), et les composants volumineux ou complexes comme `useGenericEntityDetails.js` et `LegalInfoSection.js`.  - [x] 5.2. Proposer un plan de mise en place des tests (outils, priorités, structure, exemples) (Tests unitaires existants pour certains hooks (`useConcertDetailsMigrated`, `useGenericEntityDetails`, etc.) avec Jest. Recommandations: 
    - **Outillage:** Conserver Jest + React Testing Library pour les tests unitaires et d'intégration. Introduire Cypress pour les tests End-to-End (E2E).
    - **Priorités:** 1) Zones critiques (génération PDF, formulaires, authentification, interactions Firestore). 2) Composants réutilisables (UI, common). 3) Parcours utilisateurs clés (création de concert, réservation, etc.).
    - **Structure:** Tests unitaires pour les fonctions utilitaires, hooks et composants atomiques. Tests d'intégration pour les composants plus complexes et les flux de données. Tests E2E pour les scénarios utilisateurs complets.
    - **Exemples:** Test unitaire pour une fonction de validation de formulaire (ex: `src/utils/validators.js` si existant, sinon à créer). Test d'intégration pour le composant `ArtisteForm` (vérifier la soumission correcte des données, la gestion des erreurs de validation). Test E2E pour la création d'un artiste depuis la liste jusqu'à la page de détail, incluant la navigation et la vérification des données affichées- [x] 6. Vérification de la documentation et de la cohérence de la migration] 6.1. Vérifier la cohérence des `README.md`, `docs/`, `docs/migration/` avec le code (Terminé: `README.md`, `docs/hooks/STANDARDISATION_HOOKS.md`, `docs/components/COMMON_COMPONENTS.md`, `docs/hooks/HOOKS.md`, `docs/workflows/WORKFLOWS.md` sont détaillés et globalement alignés. Le plan `docs/hooks/PLAN_MIGRATION_HOOKS_GENERIQUES.md` est archivé et complet. `docs/ARCHITECTURE.md` et `docs/CONCERT_REFACTORING.md` sont manquants. Les dossiers `docs/migration/`, `docs/hooks/` et `docs/archive/` contiennent de nombreux documents de suivi de migration, la plupart archivés ou indiquant une complétion.)
  - [ ] 6.2. Archiver les fichiers dans `docs/migration/` si les plans sont exécutés
  - [ ] 6.3. Nettoyer les mentions obsolètes dans la documentation
- [ ] 7. Nettoyage des fichiers inutiles
  - [x] 7.1. Identifier les fichiers 100% inutilisés (Les hooks `useIsMobile.js`, `useLocationIQ.js`, `useTheme.js` n'existent plus, confirmant leur suppression/migration. D'autres fichiers potentiellement inutilisés doivent être vérifiés avec une analyse d'utilisation approfondie.)
  - [x] 7.2. Fournir une liste finale des fichiers sûrs à supprimer (Liste à réviser: `src/styles/components/concerts.css` pourrait être obsolète mais nécessite une vérification d'utilisation. Note: `src/styles/components/concerts-mobile.css` contient du code fonctionnel et ne doit PAS être supprimé. Les fichiers JSX mentionnés précédemment n'existent pas dans le projet actuel.)
  - [ ] 7.3. Fournir une commande bash pour suppression avec sauvegarde
- [ ] 8. Génération des plans d’action en Markdown
- [ ] 9. Compilation du rapport final et envoi à l'utilisateur

